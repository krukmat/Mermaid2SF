<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flow Visualizer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" />
  <style>
    :root {
      --bg: #0b1021;
      --panel: #131a33;
      --accent: #66e0ff;
      --text: #e8ecff;
      --muted: #9aa5d3;
      --surface: #1c2547;
      --pill: #223054;
    }
    [data-theme='light'] {
      --bg: #f5f7ff;
      --panel: #ffffff;
      --accent: #2b7fff;
      --text: #0b1530;
      --muted: #5c6a8a;
      --surface: #f0f3ff;
      --pill: #dfe6f7;
    }
    body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); transition: background 180ms ease, color 180ms ease; }
    header { padding: 1rem 1.5rem; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #22305422; position: sticky; top: 0; z-index: 5; flex-wrap: wrap; gap: 0.5rem; }
    main { display: grid; grid-template-columns: 340px 1fr; min-height: 100vh; }
    .hero { background: radial-gradient(circle at 20% 20%, rgba(102,224,255,0.08), transparent 35%), radial-gradient(circle at 80% 0%, rgba(111,90,255,0.12), transparent 40%), linear-gradient(135deg, var(--panel), var(--bg)); color: var(--text); padding: 3rem 1.5rem 2.5rem; border-bottom: 1px solid #22305422; }
    .hero-grid { display: grid; grid-template-columns: 1fr 420px; gap: 2rem; align-items: center; }
    .hero-badge { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.7rem; border-radius: 999px; background: rgba(102,224,255,0.1); border: 1px solid rgba(102,224,255,0.25); color: var(--accent); font-weight: 700; }
    .hero-cta { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem; }
    .hero-card { background: var(--surface); border: 1px solid #22305422; border-radius: 14px; padding: 1rem; position: relative; overflow: hidden; min-height: 260px; }
    .pulse { position: absolute; width: 140px; height: 140px; border-radius: 999px; background: rgba(102,224,255,0.1); filter: blur(12px); animation: float 6s ease-in-out infinite; }
    .pulse:nth-child(1) { top: -20px; left: -10px; animation-delay: 0.2s; }
    .pulse:nth-child(2) { bottom: -20px; right: -20px; animation-delay: 1.4s; }
    .pulse:nth-child(3) { top: 40%; left: 40%; animation-delay: 2.1s; }
    .hero-diagram { position: relative; z-index: 1; display: grid; gap: 0.6rem; }
    .chip { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.35rem 0.7rem; border-radius: 10px; background: rgba(102,224,255,0.08); border: 1px solid rgba(102,224,255,0.2); font-size: 0.9rem; }
    .sidebar { background: var(--panel); padding: 1.5rem; border-right: 1px solid #22305422; overflow-y: auto; }
    .content { padding: 1.5rem; }
    .card { background: var(--surface); border: 1px solid #22305422; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.25rem; color: var(--muted); font-size: 0.9rem; }
    input, textarea { width: 100%; padding: 0.6rem 0.7rem; border-radius: 8px; border: 1px solid #22305422; background: #0f153133; color: var(--text); }
    textarea { min-height: 120px; }
    button { background: var(--accent); color: #04132e; border: none; border-radius: 8px; padding: 0.7rem 1rem; font-weight: 700; cursor: pointer; }
    button:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    button.secondary { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
    .row { display: flex; gap: 0.5rem; align-items: center; }
    .row button { flex: 1; }
    .canvas { background: #0f153133; border: 1px dashed #22305455; border-radius: 10px; padding: 1rem; min-height: 520px; overflow: hidden; position: relative; }
    .canvas-inner { position: relative; width: 100%; height: 100%; min-height: 520px; transform-origin: top left; transition: transform 120ms ease-out; }
    svg.edges { position: absolute; inset: 0; pointer-events: none; overflow: visible; }
    .edge-label { fill: #9aa5d3; font-size: 12px; pointer-events: none; }
    .edge-line { stroke: #66e0ff99; stroke-width: 2; transition: stroke 120ms ease; }
    .edge-line.highlight { stroke: #ffd166; }
    .node { position: absolute; padding: 0.4rem 0.75rem; border-radius: 8px; display: inline-flex; gap: 0.4rem; align-items: center; cursor: grab; user-select: none; }
    .node.start { background: #14d88e33; border: 1px solid #14d88e; }
    .node.end { background: #ff758c33; border: 1px solid #ff758c; }
    .node.decision { background: #f5a52433; border: 1px solid #f5a524; }
    .node.default { background: #66e0ff33; border: 1px solid #66e0ff; }
    .edge { color: var(--muted); font-size: 0.85rem; }
    .list { list-style: none; padding: 0; margin: 0; }
    .list li { background: #0f153133; border: 1px solid #22305455; border-radius: 8px; padding: 0.6rem; margin-bottom: 0.4rem; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
    .list li.dragging { opacity: 0.6; }
    .pill { padding: 0.2rem 0.5rem; border-radius: 8px; background: var(--pill); color: var(--muted); font-size: 0.8rem; display: inline-flex; align-items: center; gap: 0.35rem; }
    .template-grid { display: grid; gap: 0.5rem; }
    .template-card { border: 1px dashed #22305444; border-radius: 10px; padding: 0.6rem 0.75rem; background: #0f153122; }
    .template-card header { display: flex; justify-content: space-between; align-items: center; padding: 0; background: transparent; border: none; }
    .template-card small { color: var(--muted); }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; z-index: 20; }
    .modal { background: var(--panel); border: 1px solid #22305455; border-radius: 12px; width: min(560px, 90vw); max-height: 80vh; overflow: auto; padding: 1rem 1.25rem; box-shadow: 0 20px 60px rgba(0,0,0,0.35); }
    .modal header { display: flex; justify-content: space-between; align-items: center; padding: 0; border: none; }
    .modal .row { flex-wrap: wrap; }
    @keyframes float { 0% { transform: translateY(0); opacity: 0.9; } 50% { transform: translateY(-10px); opacity: 1; } 100% { transform: translateY(0); opacity: 0.9; } }
    @media (max-width: 1100px) {
      main { grid-template-columns: 1fr; }
      .hero-grid { grid-template-columns: 1fr; }
      .sidebar { order: 2; }
      .content { order: 1; }
    }
    @media (max-width: 768px) {
      .row { flex-wrap: wrap; }
      .hero { padding: 2.5rem 1rem 2rem; }
      header { padding: 0.75rem 1rem; }
    }
  </style>
</head>
<body>
  <header>
    <h2>Flow Visualizer</h2>
    <div class="row" style="gap:0.75rem;">
      <button id="themeToggle" class="secondary" style="min-width:120px;" aria-pressed="false" aria-label="Toggle theme">Toggle Theme</button>
      <button id="ping">Check Backend</button>
      <button class="secondary" id="reset">Reset</button>
    </div>
  </header>
  <section class="hero">
    <div class="hero-grid">
      <div>
        <div class="hero-badge">Flows as Code ¬∑ Git/CI Ready</div>
        <h1 style="margin:0.6rem 0 0.4rem;">Build Salesforce Flows Visually, Ship from Git</h1>
        <p style="color: var(--muted); max-width: 640px;">
          Drag, drop, compile. From Mermaid diagrams to deployable Flow XML with live previews, examples, and a ready-to-use CI pipeline.
        </p>
        <div class="hero-cta">
          <button onclick="scrollToBuilder()">Start Building</button>
          <button class="secondary" onclick="loadTemplate('onboarding')">Use Onboarding Template</button>
          <button class="secondary" onclick="window.open('http://iotforce.es/flow/', '_blank')">Try Live Demo</button>
        </div>
        <div style="margin-top:0.75rem; display:flex; gap:0.5rem; flex-wrap: wrap;">
          <span class="chip">Mermaid ‚Üí XML/DSL/Docs</span>
          <span class="chip">Live XML Preview</span>
          <span class="chip">CI-ready (lint/test/build)</span>
        </div>
      </div>
      <div class="hero-card">
        <div class="pulse"></div><div class="pulse"></div><div class="pulse"></div>
        <div class="hero-diagram">
          <div class="node start" style="position:relative;">‚ñ∂ Start</div>
          <div class="edge">‚Üí Screen: Collect Info</div>
          <div class="node default" style="position:relative;">üìã Screen</div>
          <div class="edge">‚Üí Decision: Route</div>
          <div class="node decision" style="position:relative;">üîÄ Decision</div>
          <div class="edge">Yes ‚Üí Assignment / No ‚Üí End</div>
          <div class="node default" style="position:relative;">‚úèÔ∏è Assignment</div>
          <div class="node end" style="position:relative;">‚èπ End</div>
        </div>
      </div>
    </div>
  </section>
  <main>
    <section class="sidebar">
      <div class="card">
        <strong>Toolbox</strong>
        <div class="row" style="margin-top:0.5rem; flex-wrap: wrap;">
          <button data-add="Start">+ Start</button>
          <button data-add="Screen">+ Screen</button>
          <button data-add="Assignment">+ Assignment</button>
          <button data-add="Decision">+ Decision</button>
          <button data-add="GetRecords">+ GetRecords</button>
          <button data-add="End">+ End</button>
        </div>
      </div>
      <div class="card">
        <strong>Templates</strong>
        <div class="template-grid" id="templateGrid" style="margin-top:0.5rem;"></div>
      </div>
      <div class="card">
        <strong>Nodes (drag to reorder)</strong>
        <ul id="nodeList" class="list"></ul>
      </div>
      <div class="card" id="editorCard" style="display:none;">
        <strong>Edit Node</strong>
        <div style="margin-top:0.5rem;" id="form"></div>
      </div>
      <div class="card">
        <strong>Export</strong>
        <div class="row" style="margin-top:0.5rem;">
          <button id="exportMermaid">Mermaid</button>
          <button class="secondary" id="exportDsl">DSL JSON</button>
        </div>
      </div>
      <div class="card">
        <strong>Status</strong>
        <pre id="output" style="white-space:pre-wrap; background:#0f1531; padding:0.75rem; border-radius:8px; border:1px solid #223054;">Ready.</pre>
      </div>
    </section>
    <section class="content" id="builder">
      <div class="card">
        <h3 style="margin-top:0;">Canvas</h3>
        <div class="row" style="gap:0.5rem; margin-bottom:0.5rem; flex-wrap: wrap;">
          <span class="pill">View</span>
          <button class="secondary" id="zoomOut" style="min-width:72px;">-</button>
          <button class="secondary" id="zoomIn" style="min-width:72px;">+</button>
          <button id="resetView" style="min-width:120px;">Reset</button>
        </div>
        <div class="canvas" id="canvas">
          <div class="canvas-inner" id="canvasInner"></div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:0;">Mermaid Preview</h3>
        <pre id="mermaidPreview" style="background:#0f1531; padding:1rem; border-radius:8px; border:1px solid #223054; white-space:pre-wrap;"></pre>
      </div>
      <div class="card">
        <h3 style="margin-top:0;">XML Preview</h3>
        <div class="row" style="margin-bottom:0.5rem;">
          <button id="compileXml">Compile &amp; Preview XML</button>
          <button class="secondary" id="downloadXml">Download XML</button>
        </div>
        <pre id="xmlPreview" class="language-xml" style="background:#0f1531; padding:1rem; border-radius:8px; border:1px solid #223054; white-space:pre-wrap; max-height:260px; overflow:auto;">Not compiled yet.</pre>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script>
    const API_BASE = (window.location && window.location.origin) || 'http://localhost:4000';

    const output = document.getElementById('output');
    const canvas = document.getElementById('canvas');
    const canvasInner = document.getElementById('canvasInner');
    const list = document.getElementById('nodeList');
    const form = document.getElementById('form');
    const editorCard = document.getElementById('editorCard');
    const mermaidPreview = document.getElementById('mermaidPreview');
    const templateGrid = document.getElementById('templateGrid');
    let modalEl = null;

    let nodes = [];
    let selectedId = null;
    let scale = 1;
    let panX = 0;
    let panY = 0;
    let isPanning = false;
    let panStart = { x: 0, y: 0 };
    let draggingNode = null;
    let dragOffset = { x: 0, y: 0 };

    const sampleNodes = [
      { id: 'Start_1', type: 'Start', label: 'Demo Start', apiName: 'Start_1', next: 'Screen_1', x: 80, y: 60 },
      { id: 'Screen_1', type: 'Screen', label: 'Collect Data', apiName: 'Screen_1', next: 'Decision_1', x: 320, y: 60 },
      { id: 'Decision_1', type: 'Decision', label: 'Route', apiName: 'Decision_1', yesNext: 'Assign_1', noNext: 'End_1', x: 560, y: 60 },
      { id: 'Assign_1', type: 'Assignment', label: 'Set Flag', apiName: 'Assign_1', next: 'End_1', assignments: 'v_Flag = true', x: 800, y: 40 },
      { id: 'End_1', type: 'End', label: 'Done', apiName: 'End_1', x: 800, y: 160 },
    ];

    const templates = {
      onboarding: {
        name: 'Customer Onboarding',
        description: 'Screen + Decision + Record create/update + Email subflow',
        nodes: [
          { id: 'Start_1', type: 'Start', label: 'Start', apiName: 'Start_1', next: 'Screen_1', x: 60, y: 80 },
          { id: 'Screen_1', type: 'Screen', label: 'Collect Info', apiName: 'Screen_1', next: 'Decision_1', x: 260, y: 80 },
          { id: 'Decision_1', type: 'Decision', label: 'Existing Customer?', apiName: 'Decision_1', yesNext: 'Update_1', noNext: 'Create_1', x: 480, y: 80 },
          { id: 'Create_1', type: 'RecordCreate', label: 'Create Account', apiName: 'Create_1', next: 'Email_1', x: 700, y: 20 },
          { id: 'Update_1', type: 'RecordUpdate', label: 'Update Account', apiName: 'Update_1', next: 'Email_1', x: 700, y: 140 },
          { id: 'Email_1', type: 'Subflow', label: 'Send Welcome Email', apiName: 'Email_1', next: 'End_1', x: 920, y: 80 },
          { id: 'End_1', type: 'End', label: 'Done', apiName: 'End_1', x: 1120, y: 80 },
        ],
      },
      lead: {
        name: 'Lead Routing',
        description: 'Decision + Assignment + GetRecords to route leads',
        nodes: [
          { id: 'Start_1', type: 'Start', label: 'Start', apiName: 'Start_1', next: 'Decision_1', x: 60, y: 80 },
          { id: 'Decision_1', type: 'Decision', label: 'Qualified?', apiName: 'Decision_1', yesNext: 'Assign_1', noNext: 'End_1', x: 260, y: 80 },
          { id: 'Assign_1', type: 'Assignment', label: 'Set Owner', apiName: 'Assign_1', assignments: 'Owner = Queue', next: 'Get_1', x: 500, y: 30 },
          { id: 'Get_1', type: 'GetRecords', label: 'Lookup Lead', apiName: 'Get_1', next: 'End_1', x: 740, y: 80 },
          { id: 'End_1', type: 'End', label: 'Done', apiName: 'End_1', x: 980, y: 80 },
        ],
      },
      case: {
        name: 'Case Escalation',
        description: 'Screen + Decision + Wait/Fault connectors simplified',
        nodes: [
          { id: 'Start_1', type: 'Start', label: 'Start', apiName: 'Start_1', next: 'Screen_1', x: 60, y: 80 },
          { id: 'Screen_1', type: 'Screen', label: 'Capture Case', apiName: 'Screen_1', next: 'Decision_1', x: 260, y: 80 },
          { id: 'Decision_1', type: 'Decision', label: 'Severity?', apiName: 'Decision_1', yesNext: 'Assign_1', noNext: 'Wait_1', x: 480, y: 80 },
          { id: 'Assign_1', type: 'Assignment', label: 'Escalate Owner', apiName: 'Assign_1', assignments: 'Owner = Tier2', next: 'End_1', x: 700, y: 20 },
          { id: 'Wait_1', type: 'Wait', label: 'Follow-up', apiName: 'Wait_1', next: 'End_1', x: 700, y: 140 },
          { id: 'End_1', type: 'End', label: 'Complete', apiName: 'End_1', x: 920, y: 80 },
        ],
      },
    };

    const iconMap = {
      Start: '‚ñ∂',
      End: '‚èπ',
      Screen: 'üìã',
      Decision: 'üîÄ',
      Assignment: '‚úèÔ∏è',
      RecordCreate: '‚ûï',
      RecordUpdate: 'üõ†',
      GetRecords: 'üìä',
      Subflow: 'üîÅ',
      Loop: '‚ü≥',
      Wait: '‚è≥',
      Fault: '‚ö†Ô∏è',
      default: '‚¨¢',
    };

    const typeDefaults = {
      Start: () => ({ type: 'Start', label: 'Start', next: '' }),
      End: () => ({ type: 'End', label: 'End' }),
      Screen: () => ({ type: 'Screen', label: 'Screen', next: '' }),
      Assignment: () => ({ type: 'Assignment', label: 'Assignment', assignments: '', next: '' }),
      Decision: () => ({ type: 'Decision', label: 'Decision', yesNext: '', noNext: '' }),
      GetRecords: () => ({ type: 'GetRecords', label: 'Get Records', object: '', fields: '', filters: '', next: '' }),
    };

    function init() {
      nodes = [...sampleNodes];
      renderTemplates();
      restoreTheme();
      renderAll();
    }

    function renderAll() {
      renderList();
      renderCanvas();
      renderPreview();
      renderForm();
    }

    function applyTransform() {
      canvasInner.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
    }

    function renderList() {
      list.innerHTML = '';
      if (nodes.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'canvas-empty';
        empty.innerHTML = `<div class="node default" style="position:relative; margin-bottom:0.5rem;">Start by adding a node</div><p style="color:var(--muted);">Use the toolbox to add Start, Screen, Decision, or use a template.</p>`;
        empty.setAttribute('role', 'status');
        empty.setAttribute('aria-live', 'polite');
        canvasInner.appendChild(empty);
      }
      nodes.forEach((n) => {
        const li = document.createElement('li');
        li.draggable = true;
        li.dataset.id = n.id;
        const icon = iconMap[n.type] || iconMap.default;
        li.innerHTML = `<div style="display:flex; align-items:center; gap:0.4rem;"><span>${icon}</span>${n.id}</div><span class="pill"><span>${icon}</span>${n.type}</span>`;
        li.addEventListener('click', () => {
          selectedId = n.id;
          renderForm();
        });
        li.addEventListener('dragstart', (e) => {
          li.classList.add('dragging');
          e.dataTransfer.setData('text/plain', n.id);
        });
        li.addEventListener('dragend', () => li.classList.remove('dragging'));
        list.appendChild(li);
      });
      list.addEventListener('dragover', (e) => {
        e.preventDefault();
        const dragging = document.querySelector('.dragging');
        const afterElement = getDragAfterElement(list, e.clientY);
        if (!dragging) return;
        if (afterElement == null) {
          list.appendChild(dragging);
        } else {
          list.insertBefore(dragging, afterElement);
        }
      });
      list.addEventListener('drop', () => {
        const newOrder = Array.from(list.children).map((li) => li.dataset.id);
        nodes.sort((a, b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));
        renderAll();
      });
    }

    function renderTemplates() {
      if (!templateGrid) return;
      templateGrid.innerHTML = '';
      Object.entries(templates).forEach(([key, tpl]) => {
        const div = document.createElement('div');
        div.className = 'template-card';
        div.innerHTML = `
          <header>
            <div>
              <strong>${tpl.name}</strong><br/>
              <small>${tpl.description}</small>
            </div>
            <span class="pill">Template</span>
          </header>
          <div class="row" style="margin-top:0.5rem;">
            <button data-use="${key}" aria-label="Use template ${tpl.name}">Use</button>
            <button class="secondary" data-preview="${key}" aria-label="Preview template ${tpl.name}">Preview</button>
          </div>
        `;
        div.querySelector('[data-use]').addEventListener('click', () => loadTemplate(key));
        div.querySelector('[data-preview]').addEventListener('click', () => {
          nodes = [...templates[key].nodes];
          renderAll();
        });
        templateGrid.appendChild(div);
      });
    }

    function loadTemplate(key) {
      const tpl = templates[key];
      if (!tpl) return;
      nodes = JSON.parse(JSON.stringify(tpl.nodes));
      selectedId = null;
      renderAll();
      scrollToBuilder();
      output.textContent = `Template loaded: ${tpl.name}`;
    }

    function scrollToBuilder() {
      const builder = document.querySelector('main');
      if (builder) builder.scrollIntoView({ behavior: 'smooth' });
    }

    function getDragAfterElement(container, y) {
      const elements = [...container.querySelectorAll('li:not(.dragging)')];
      return elements.reduce(
        (closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY, element: null },
      ).element;
    }

    function renderCanvas() {
      canvasInner.innerHTML = '';
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.classList.add('edges');
      canvasInner.appendChild(svg);

      nodes.forEach((n) => {
        const icon = iconMap[n.type] || iconMap.default;
        const div = document.createElement('div');
        let cls = 'node default';
        if (n.type === 'Start') cls = 'node start';
        else if (n.type === 'End') cls = 'node end';
        else if (n.type === 'Decision') cls = 'node decision';
        div.className = cls;
        div.innerHTML = `<span>${icon}</span><span>${n.id}: ${n.label || n.apiName || n.type}</span>`;
        div.style.transform = `translate(${n.x || 0}px, ${(n.y || 0)}px)`;
        div.setAttribute('role', 'button');
        div.setAttribute('aria-label', `${n.type} node ${n.label || n.id}`);
        div.addEventListener('mousedown', (e) => startNodeDrag(e, n.id));
        div.addEventListener('click', () => { selectedId = n.id; renderForm(); });
        canvasInner.appendChild(div);
      });

      drawEdges(svg);
      applyTransform();
    }

    function drawEdges(svg) {
      const rect = canvasInner.getBoundingClientRect();
      const nodeMap = new Map();
      canvasInner.querySelectorAll('.node').forEach((el) => {
        const id = el.textContent.split(':')[0].trim();
        const box = el.getBoundingClientRect();
        nodeMap.set(id, {
          x: box.left - rect.left + box.width / 2,
          y: box.top - rect.top + box.height / 2,
        });
      });
      const edges = collectConnections();
      edges.forEach(({ from, to, label }) => {
        const a = nodeMap.get(from);
        const b = nodeMap.get(to);
        if (!a || !b) return;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.classList.add('edge-line');
        line.setAttribute('x1', a.x);
        line.setAttribute('y1', a.y);
        line.setAttribute('x2', b.x);
        line.setAttribute('y2', b.y);
        line.setAttribute('marker-end', 'url(#arrow)');
        svg.appendChild(line);
        if (label) {
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.classList.add('edge-label');
          text.setAttribute('x', (a.x + b.x) / 2);
          text.setAttribute('y', (a.y + b.y) / 2 - 6);
          text.textContent = label;
          svg.appendChild(text);
        }
      });
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
      marker.setAttribute('id', 'arrow');
      marker.setAttribute('viewBox', '0 0 10 10');
      marker.setAttribute('refX', '5');
      marker.setAttribute('refY', '5');
      marker.setAttribute('markerWidth', '6');
      marker.setAttribute('markerHeight', '6');
      marker.setAttribute('orient', 'auto-start-reverse');
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M 0 0 L 10 5 L 0 10 z');
      path.setAttribute('fill', '#66e0ff99');
      marker.appendChild(path);
      defs.appendChild(marker);
      svg.prepend(defs);
    }

    function collectConnections() {
      const edges = [];
      nodes.forEach((n, idx) => {
        if (n.type === 'Decision') {
          if (n.yesNext) edges.push({ from: n.id, to: n.yesNext, label: 'Yes' });
          if (n.noNext) edges.push({ from: n.id, to: n.noNext, label: 'No/default' });
        } else if (n.next) {
          edges.push({ from: n.id, to: n.next });
        } else if (!n.next && idx < nodes.length - 1 && n.type !== 'End') {
          edges.push({ from: n.id, to: nodes[idx + 1].id });
        }
      });
      return edges;
    }

    function startNodeDrag(e, id) {
      draggingNode = nodes.find((n) => n.id === id);
      if (!draggingNode) return;
      const rect = canvasInner.getBoundingClientRect();
      const nodeRect = e.currentTarget.getBoundingClientRect();
      dragOffset = {
        x: e.clientX - nodeRect.left + rect.left,
        y: e.clientY - nodeRect.top + rect.top,
      };
      window.addEventListener('mousemove', onNodeDrag);
      window.addEventListener('mouseup', endNodeDrag);
      e.preventDefault();
    }

    function onNodeDrag(e) {
      if (!draggingNode) return;
      const rect = canvasInner.getBoundingClientRect();
      draggingNode.x = e.clientX - rect.left - (dragOffset.x - rect.left);
      draggingNode.y = e.clientY - rect.top - (dragOffset.y - rect.top);
      renderCanvas();
    }

    function endNodeDrag() {
      draggingNode = null;
      window.removeEventListener('mousemove', onNodeDrag);
      window.removeEventListener('mouseup', endNodeDrag);
      renderPreview();
    }

    function setScale(next) {
      scale = Math.min(2, Math.max(0.4, next));
      applyTransform();
    }

    function renderForm() {
      const node = nodes.find((n) => n.id === selectedId);
      if (!node) {
        editorCard.style.display = 'none';
        form.innerHTML = '';
        return;
      }
      editorCard.style.display = 'block';
      form.innerHTML = '';
      renderModal(node);
    }

    function inputField(labelText, value, onChange, type = 'text') {
      const wrap = document.createElement('div');
      wrap.style.marginBottom = '0.75rem';
      const lab = document.createElement('label');
      lab.textContent = labelText;
      const input = document.createElement('input');
      input.type = type;
      input.value = value;
      input.addEventListener('input', (e) => onChange(e.target.value));
      wrap.appendChild(lab);
      wrap.appendChild(input);
      return wrap;
    }

    function renderPreview() {
      if (nodes.length === 0) {
        mermaidPreview.textContent = 'No diagram yet. Add nodes to see a Mermaid preview.';
        return;
      }
      if (nodes.length === 0) {
        mermaidPreview.textContent = 'No diagram yet. Add nodes to see a Mermaid preview.';
        return;
      }
      const mermaid = generateMermaid(nodes);
      mermaidPreview.textContent = mermaid;
    }

    function renderModal(node) {
      closeModal();
      modalEl = document.createElement('div');
      modalEl.className = 'modal-backdrop';
      modalEl.innerHTML = `
        <div class="modal" role="dialog" aria-modal="true" aria-label="Edit ${node.type} node">
          <header>
            <h3 style="margin:0;">Edit ${node.type}</h3>
            <button class="secondary" id="closeModal" aria-label="Close edit dialog">‚úï</button>
          </header>
          <div id="modalBody"></div>
          <div class="row" style="margin-top:0.5rem;">
            <button class="secondary" id="cancelModal">Cancel</button>
            <button id="saveModal">Save</button>
          </div>
        </div>
      `;
      modalEl.addEventListener('click', (e) => {
        if (e.target === modalEl) closeModal();
      });
      document.body.appendChild(modalEl);
      const body = modalEl.querySelector('#modalBody');
      body.appendChild(inputField('Label', node.label || '', (v) => (node.label = v)));
      body.appendChild(inputField('API Name', node.apiName || '', (v) => (node.apiName = v)));
      body.appendChild(inputField('X', node.x ?? 0, (v) => (node.x = Number(v) || 0), 'number'));
      body.appendChild(inputField('Y', node.y ?? 0, (v) => (node.y = Number(v) || 0), 'number'));
      if (node.type !== 'End' && node.type !== 'Decision') {
        body.appendChild(targetSelect('Next', node.next || '', (v) => (node.next = v)));
      }
      if (node.type === 'Decision') {
        body.appendChild(targetSelect('Yes Next', node.yesNext || '', (v) => (node.yesNext = v)));
        body.appendChild(targetSelect('No/Default Next', node.noNext || '', (v) => (node.noNext = v)));
      }
      if (node.type === 'Assignment') {
        body.appendChild(inputField('Assignments (text)', node.assignments || '', (v) => (node.assignments = v)));
      }
      if (node.type === 'GetRecords') {
        body.appendChild(inputField('Object', node.object || '', (v) => (node.object = v)));
        body.appendChild(inputField('Fields (comma)', node.fields || '', (v) => (node.fields = v)));
        body.appendChild(inputField('Filters (key=value;)', node.filters || '', (v) => (node.filters = v)));
      }
      if (node.type === 'Wait') {
        body.appendChild(inputField('Label', node.label || '', (v) => (node.label = v)));
      }
      if (node.type === 'Loop') {
        body.appendChild(inputField('Label', node.label || '', (v) => (node.label = v)));
      }
      modalEl.querySelector('#closeModal').addEventListener('click', closeModal);
      modalEl.querySelector('#cancelModal').addEventListener('click', closeModal);
      modalEl.querySelector('#saveModal').addEventListener('click', () => {
        closeModal();
        renderAll();
      });
    }

    function targetSelect(labelText, value, onChange) {
      const wrap = document.createElement('div');
      wrap.style.marginBottom = '0.75rem';
      const lab = document.createElement('label');
      lab.textContent = labelText;
      const sel = document.createElement('select');
      sel.innerHTML = `<option value=\"\">(none)</option>` + nodes.map((n) => `<option value=\"${n.id}\" ${value === n.id ? 'selected' : ''}>${n.id}</option>`).join('');
      sel.addEventListener('change', (e) => onChange(e.target.value));
      wrap.appendChild(lab);
      wrap.appendChild(sel);
      return wrap;
    }

    function closeModal() {
      if (modalEl && modalEl.parentNode) {
        modalEl.parentNode.removeChild(modalEl);
        modalEl = null;
      }
    }

    function highlightXmlBlock() {
      if (typeof Prism === 'undefined') return;
      const block = document.getElementById('xmlPreview');
      Prism.highlightElement(block);
    }

    function generateMermaid(nodesList) {
      const lines = ['flowchart TD'];
      nodesList.forEach((n) => {
        const label = n.label || n.type;
        if (n.type === 'Start') lines.push(`  ${n.id}([START: ${label}])`);
        else if (n.type === 'End') lines.push(`  ${n.id}([END: ${label}])`);
        else if (n.type === 'Decision') lines.push(`  ${n.id}{DECISION: ${label}\\n api: ${n.apiName || n.id}}`);
        else if (n.type === 'Assignment') lines.push(`  ${n.id}[ASSIGNMENT: ${label}\\n api: ${n.apiName || n.id}\\n set: ${n.assignments || ''}]`);
        else if (n.type === 'Screen') lines.push(`  ${n.id}[SCREEN: ${label}\\n api: ${n.apiName || n.id}]`);
        else if (n.type === 'GetRecords') lines.push(`  ${n.id}[GET: ${label}\\n api: ${n.apiName || n.id}\\n object: ${n.object || ''}\\n field: ${(n.fields || '').split(',')[0] || ''}]`);
        else lines.push(`  ${n.id}[${label}]`);
      });
      nodesList.forEach((n, idx) => {
        if (n.type === 'Decision') {
          if (n.yesNext) lines.push(`  ${n.id} -->|Yes| ${n.yesNext}`);
          if (n.noNext) lines.push(`  ${n.id} -->|No default| ${n.noNext}`);
        } else if (n.next) {
          lines.push(`  ${n.id} --> ${n.next}`);
        } else if (!n.next && idx < nodesList.length - 1 && n.type !== 'End') {
          lines.push(`  ${n.id} --> ${nodesList[idx + 1].id}`);
        }
      });
      return lines.join('\n');
    }

    function generateDsl(nodesList) {
      const start = nodesList.find((n) => n.type === 'Start')?.id || nodesList[0]?.id || '';
      const elements = nodesList.map((n) => {
        const base = {
          id: n.id,
          type: n.type,
          apiName: n.apiName || n.id,
          label: n.label,
        };
        if (n.type === 'Decision') {
          const outcomes = [];
          if (n.yesNext) outcomes.push({ name: 'Yes', next: n.yesNext });
          if (n.noNext) outcomes.push({ name: 'No', next: n.noNext, isDefault: true });
          return { ...base, outcomes };
        }
        if (n.type === 'Assignment') {
          return { ...base, assignments: n.assignments ? [{ variable: 'v_Flag', value: n.assignments }] : [], next: n.next };
        }
        if (n.type === 'GetRecords') {
          const fields = (n.fields || '')
            .split(',')
            .map((f) => f.trim())
            .filter(Boolean);
          const filters = (n.filters || '')
            .split(';')
            .map((p) => p.trim())
            .filter(Boolean)
            .map((pair) => {
              const [field, value] = pair.split('=')
                .map((s) => s.trim());
              return { field, operator: 'EqualTo', value };
            });
          return { ...base, object: n.object || '', fields, filters, next: n.next };
        }
        if (n.type !== 'End') {
          return { ...base, next: n.next };
        }
        return base;
      });
      return {
        version: 1,
        flowApiName: 'VisualizerFlow',
        label: 'Visualizer Flow',
        processType: 'Autolaunched',
        startElement: start,
        elements,
      };
    }

    document.querySelectorAll('[data-add]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const type = btn.dataset.add;
        const base = typeDefaults[type] ? typeDefaults[type]() : { type, label: type };
        const id = `${type}_${nodes.filter((n) => n.type === type).length + 1}`;
        nodes.push({ id, apiName: id, x: 100 + nodes.length * 60, y: 100 + (nodes.length % 3) * 80, ...base });
        selectedId = id;
        renderAll();
      });
    });

    document.getElementById('exportMermaid').addEventListener('click', () => {
      const mermaid = generateMermaid(nodes);
      navigator.clipboard?.writeText(mermaid).catch(() => {});
      output.textContent = 'Mermaid generated (copied to clipboard if permitted).';
      mermaidPreview.textContent = mermaid;
    });

    document.getElementById('exportDsl').addEventListener('click', () => {
      const dsl = generateDsl(nodes);
      const text = JSON.stringify(dsl, null, 2);
      navigator.clipboard?.writeText(text).catch(() => {});
      output.textContent = 'DSL JSON generated (copied to clipboard if permitted).';
    });

    document.getElementById('zoomIn').addEventListener('click', () => setScale(scale + 0.15));
    document.getElementById('zoomOut').addEventListener('click', () => setScale(scale - 0.15));
    document.getElementById('resetView').addEventListener('click', () => {
      scale = 1;
      panX = 0;
      panY = 0;
      applyTransform();
    });

    canvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      setScale(scale + delta);
    });

    canvas.addEventListener('mousedown', (e) => {
      if (e.target.closest('.node')) return;
      isPanning = true;
      panStart = { x: e.clientX, y: e.clientY };
      canvas.style.cursor = 'grabbing';
    });

    window.addEventListener('mousemove', (e) => {
      if (!isPanning) return;
      const dx = e.clientX - panStart.x;
      const dy = e.clientY - panStart.y;
      panStart = { x: e.clientX, y: e.clientY };
      panX += dx;
      panY += dy;
      applyTransform();
    });

    window.addEventListener('mouseup', () => {
      isPanning = false;
      canvas.style.cursor = 'grab';
    });

    document.getElementById('compileXml').addEventListener('click', async () => {
      if (nodes.length === 0) {
        xmlPreview.textContent = 'Add nodes before compiling.';
        output.textContent = 'Cannot compile empty canvas.';
        return;
      }
      const mermaid = generateMermaid(nodes);
      mermaidPreview.textContent = mermaid;
      try {
        const res = await fetch(`${API_BASE}/api/compile`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mermaidText: mermaid }),
        });
        const data = await res.json();
        if (data.errors && data.errors.length > 0) {
          xmlPreview.textContent = 'Errors:\n' + data.errors.map((e) => `- ${e.code}: ${e.message}`).join('\n');
          output.textContent = 'Validation errors; XML not generated.';
          highlightXmlBlock();
          return;
        }
        xmlPreview.textContent = data.xml || 'No XML generated.';
        output.textContent = 'XML compiled via backend.';
        xmlPreview.dataset.xml = data.xml || '';
        highlightXmlBlock();
      } catch (err) {
        xmlPreview.textContent = 'Error: ' + err.message;
        highlightXmlBlock();
      }
    });

    document.getElementById('downloadXml').addEventListener('click', () => {
      const xml = xmlPreview.dataset.xml;
      if (!xml) {
        output.textContent = 'No XML to download. Compile first.';
        return;
      }
      const blob = new Blob([xml], { type: 'application/xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'flow.flow-meta.xml';
      a.click();
      URL.revokeObjectURL(url);
      output.textContent = 'XML downloaded.';
    });

    document.getElementById('ping').addEventListener('click', async () => {
      output.textContent = 'Pinging backend...';
      try {
        const res = await fetch(`${API_BASE}/health`);
        const data = await res.json();
        output.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        output.textContent = 'Error: ' + err.message;
      }
    });

    document.getElementById('reset').addEventListener('click', () => {
      nodes = [...sampleNodes];
      selectedId = null;
      output.textContent = 'Ready.';
      renderAll();
    });

    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    function toggleTheme() {
      const current = document.body.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', next);
      document.getElementById('themeToggle').setAttribute('aria-pressed', next === 'dark' ? 'false' : 'true');
      localStorage.setItem('theme', next);
    }

    function restoreTheme() {
      const stored = localStorage.getItem('theme');
      if (stored) {
        document.body.setAttribute('data-theme', stored);
        document.getElementById('themeToggle').setAttribute('aria-pressed', stored === 'dark' ? 'false' : 'true');
      } else {
        document.body.setAttribute('data-theme', 'dark');
      }
    }

    init();
  </script>
</body>
</html>
